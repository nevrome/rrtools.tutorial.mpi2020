---
name: "rrtools.tutorial.mpi2020"
output_dir: "."
author: Clemens Schmid
date: January 2020
title: Research Compendia with R
output:
  rmdformats::readthedown:
    code_folding: NULL
    self_contained: true
    thumbnails: false
    lightbox: false
css: styles.css
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)

astro <- function() {
  fontawesome::fa("user-astronaut", fill = "#c7254e", height = 30)
}
rocket <- function() {
  fontawesome::fa("rocket", fill = "#c7254e", height = 30)
}
```

**url**

![](figures/Data-Managerment-title-slide-16-9.jpg)

This tutorial was compiled by [Clemens Schmid]() for a [workshop on reproducible research and data management at MPI-SHH](https://rrdm-shh.github.io) in January 2020. It's based on and inspired by two workshops prepared by [Ben Marwick](http://faculty.washington.edu/bmarwick/) for the [SAA2019 conference](https://benmarwick.github.io/2019-04-10-saa/) and [Brown University Digital Archaeology Lab](https://benmarwick.github.io/2019-12-09-brown/).

# The Research Compendium

<div class="gallery">
<div>

## Idea

> A research compendium is a manuscript accompanied by code and data files (or persistent links to reputable online repositories) that allows reviewers and readers to reproduce and extend the results without needing any further materials from the original authors [...].
> 
> -- Marwick 2017, 442.

A research compendium contains **relevant information** to make the **scientific process** behind a book, book chapter or journal article **more transparent** and **reproducible**.

Ideally it contains **all** **data**, **code** and **text** necessary to compile the published document. 

This might be **difficult sometimes** due to raw data or text publishing **restrictions** or parts of the workflow that are **not quantitative** or inherently impossible to reproduce. 

The term research compendium therefore covers a whole **range of imaginable degrees of completeness**.

</div>
<div>

## Data

Research can only be **reproduced**, **checked** and **expanded** when underlying raw data is available.

Data sharing is a **moral obligation** and **non-trivial**. Marwick & Birch 2018 have some recommendations:

- Anticipate how your data will be used
- Keep raw data **raw**
- Store data in **open formats**
- Data should be structured for analysis (**tidy data**)
- Data should be uniquely identifiable (**persistent references**)
- Provide relevant **metadata**
- Adopt the proper **privacy** protocols
- Use a trustworthy **repository**
- Use an open **license**

</div>
<div>

## Code

In most contexts of **quantitative research** data analysis can be expressed in the form of a **computer script**.

Other researchers should at least be able to run our script with our data to **obtain exactly the same statistical results and data visualizations**. 

**Computational reproducibility** is an important foundation of scientific progress, that requires a **new type of researcher**:

![](figures/marwick_T_Pi_researcher.png)

</div>
<div>

## What we will do today

Research compendia can be compiled in many different ways. 

I will present **one particular workflow** based on our R package [rrtools](https://github.com/benmarwick/rrtools). 

![](figures/screenshot_rrtools.png)

</div>
</div>

The following figure by [Marwick 2017](https://www.practicereproducibleresearch.org/case-studies/benmarwick.html) illustrates one implementation of this workflow.

<details>
<img src="figures/marwick_workflow.png">
</details>

# R for reproducible research

<div class="gallery">
<div>

## R

[R](https://www.r-project.org/) is a **scripting language** and a framework for statistical data analysis. The way it is used for data analysis fits well to the research compendium concept. 

1. It is an easy to learn programming language with a huge community in science.
2. It is supported by an advanced working environment: **RStudio** 
3. it allows for direct integration of code and text: **RMarkdown**
4. It offers an established data structure to manage code, data and text: the **R package**

If you never worked with R, you can use [swirl](https://swirlstats.com/students.html) to learn the basics.

</div>
<div>

## RStudio

[RStudio](https://rstudio.com/products/rstudio/) is an **integrated development environment** (IDE) specifically designed for R. 

Open RStudio or log into this RStudio Cloud session with your Github account: https://rstudio.cloud/project/848043

`r astro()``r rocket()`

</div>
<div>

## R Markdown

[Markdown](https://daringfireball.net/projects/markdown/) is a lightweight and easy-to-use **markup language** for styling your writing. 

Text written in Markdown can **easily converted** to more advanced layout systems like HTML or LaTex. This website is written in Markdown.

[Here](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet)'s a cheatsheet that documents all basic Markdown features.

```
# Header 1
## Header 2
### Header 3

- Bulleted
- List

1. Numbered
2. List

**Bold** and _Italic_ and `Code` text

[Link](url) and ![Image](src)
```

[RMarkdown](https://rmarkdown.rstudio.com/) is an advanced implementation of Markdown that allows to **combine text and code**. It adds the possibility to define chunks of code that run when the document is rendered.

`r astro()``r rocket()`

</div>
<div>

## R Packages

R packages are a core feature of R. They contain **ready to use functions, documentation and example data**. 

There currently are **>15000 R packages** mostly written and maintained by **volunteers** for all sorts of research questions and applications. 

They have an established **standard structure**:

```
mypackage/
|
├── DESCRIPTION         # Package Metadata file
├── R/                  # R code (files with functions)
├── man/                # Object (mostly functions) documentation
├── NAMESPACE/          # 
|
├── vignettes/
├── data/
|
├── tests/
├── src/
├── inst/
|
└─ .Rbuildignore/
```

[Here](http://r-pkgs.had.co.nz/)'s an excellent introduction if you want to create your own package.

</div>
</div>

# rrtools

<div class="gallery">
<div>

## Create an R package

```{r}
rrtools::use_compendium("pkgname")
```

This uses `usethis::create_package()` to create a basic R package with the name `pkgname`, and then, if you’re using RStudio, opens the project. 

ToDo:

- choose a location for the compendium package and run `rrtools::use_compendium()` (e.g. `rrtools::use_compendium("C:/Users/bmarwick/Desktop/pkgname")`).
- edit the `DESCRIPTION` file (located in your `pkgname` directory) to include accurate metadata
    
Keep in mind for the future:

- periodically update the `Imports:` section of the `DESCRIPTION` file with the names of packages used in the code we write in the Rmd document(s) (e.g., `usethis::use_package("dplyr", "imports")`)

</div>
<div>

## Activate version control

```{r}
usethis::use_git_config(user.name = "Jane Doe", user.email = "jane@example.com")
usethis::use_git()
usethis::browse_github_pat()
usethis::edit_r_environ()
usethis::use_github(protocol = "https", private = FALSE)
```

If you are connected to the internet, this initializes a local git repository (`use_git()`), then `use_github()` connects to [GitHub](https://github.com), and creates a remote repository 

ToDo:

- install and configure git *before* running this line. See [Happy Git With R](http://happygitwithr.com) for details on how to do this. Make sure to set up a [SSH key](https://happygitwithr.com/ssh-keys.html) to connect to your Github account conveniently.
- get a [personal access token](https://github.com/settings/tokens), and replace “xxxx” with that token. See the [usethis](https://usethis.r-lib.org/articles/articles/usethis-setup.html#get-and-store-a-github-personal-access-token) documentation for an easy method to get this token. When you do so (click “Generate new token”), make sure the “repo” scope is included by checking the “repo” box. Don’t save this token in your project, keep it elsewhere.
- Reopen your project in RStudio to see the git buttons on the toolbar.

Keep in mind for the future:

- Commit and push your changes to Github.

</div>
<div>

## Establish the compendium file structure

```{r}
rrtools::use_analysis()
```

</div>
<div>

## Start writing

Starting to write some text with RMarkdown

</div>
</div>



# Advanced aspects

<div class="gallery">
<div>

## Long-term data storage

</div>
<div>

## README, Code of Conduct and Contribution

```{r}
rrtools::use_readme_rmd()
```

</div>
<div>

## Licensing

```{r}
usethis::use_mit_license(name = "My Name")
```

</div>
<div>

## Virtualisation

```{r}
rrtools::use_dockerfile()
```

</div>
<div>

## CI/CD

```{r}
rrtools::use_travis(docker = FALSE)
```

</div>
<div>

## Unit tests

```{r}
usethis::use_testthat()
```

</div>
</div>

# Further reading

<p>Eglen, S. J., Marwick, B., Halchenko, Y. O., Hanke, M., Sufi, S., Gleeson, P., &hellip; &amp; Wachtler, T. (2017). Toward standard practices for sharing computer code and programs in neuroscience. <em>Nature Neuroscience</em> 20(6), 770-773. [<a href="http://doi.org/10.1038/nn.4550" target="_blank">DOI</a>] [<a href="https://doi.org/10.1101/045104" target="_blank">preprint</a>] [<a href="http://faculty.washington.edu/bmarwick/PDFs/Eglen_Marwick_et_al_2017_sharing_code.pdf" target="_blank">PDF</a>]</p>

<p>Marwick, B. 2017 Computational reproducibility in archaeological research: Basic principles and a case study of their implementation. <em>Journal of Archaeological Method and Theory</em> 24(2), 424-450. [<a href="http://doi.org/10.1007/s10816-015-9272-9" target="_blank">DOI</a>] [<a href="https://osf.io/preprints/socarxiv/q4v73" target="_blank">preprint</a>] <a href="https://doi.org/10.6084/m9.figshare.1563661" target="_blank">[code &amp; data]</a></p>

<p>Marwick 2017 Using R and Related Tools for Reproducible Research in Archaeology. In Kitzes, J., Turek, D., &amp; Deniz, F. (Eds.) <em>The Practice of Reproducible Research: Case Studies and Lessons from the Data-Intensive Sciences.</em> Oakland, CA: University of California Press. [<a href="https://www.practicereproducibleresearch.org/case-studies/benmarwick.html" target="_blank">online</a>]</p>

<p>Marwick, B., &amp; Birch, S. 2018 A Standard for the Scholarly Citation of Archaeological Data as an Incentive to Data Sharing. <em>Advances in Archaeological Practice</em> 1-19. [<a href="https://doi.org/10.1017/aap.2018.3" target="_blank">DOI</a>] [<a href="https://osf.io/preprints/socarxiv/py4hz/" target="_blank">preprint</a>] [<a href="http://faculty.washington.edu/bmarwick/PDFs/Marwick-and-Pilaar-Birch-2018-Data-Citation-AAP.pdf" target="_blank">PDF</a>] [<a href="https://doi.org/10.17605/OSF.IO/KSRUZ" target="_blank">code &amp; data</a>]</p>

<p>Marwick, B., Boettiger, C., &amp; Mullen, L. 2017 Packaging data analytical work reproducibly using R (and friends). <em>The American Statistician</em>  [<a href="https://doi.org/10.1080/00031305.2017.1375986" target="_blank">DOI</a>] [<a href="https://doi.org/10.7287/peerj.preprints.3192v1" target="_blank">preprint</a>]</p>

<p>Marwick, B, d’Alpoim Guedes, J., Barton, C. M., Bates, L. A., Baxter, M., Bevan, A., Bollwerk, E. A., Bocinsky, R. K., Brughmans, T., Carter, A. K., Conrad, C., Contreras, D. A., Costa, S., Crema, E. R., Daggett, A., Davies, B., Drake, B. L., Dye, T. S., France, P., Fullagar, R., Giusti, D., Graham, S., Harris, M. D., Hawks, J., Health, S., Huffer, D., Kansa, E. C., Kansa, S. W., Madsen, M. E., Melcher, J., Negre, J., Neiman, F. D., Opitz, R., Orton, D. C., Przstupa, P., Raviele, M., Riel-Savatore, J., Riris, P., Romanowska, I., Smith, J., Strupler, N., Ullah, I. I., Van Vlack, H. G., VanValkenburgh, N., Watrall, E. C., Webster, C., Wells, J., Winters, J., and Wren, C. D. (2017) Open science in archaeology. <em>SAA Archaeological Record</em>, 17(4), pp. 8-14. [<a href="http://bit.ly/2D7iN7n" target="_blank">PDF</a>] [<a href="https://osf.io/preprints/socarxiv/72n8g/" target="_blank">preprint</a>]</p>

<p>Ram, K. B. Marwick 2017 Building Towards a Future Where Reproducible, Open Science is the Norm. In Kitzes, J., Turek, D., &amp; Deniz, F. (Eds.) <em>The Practice of Reproducible Research: Case Studies and Lessons from the Data-Intensive Sciences.</em> Oakland, CA: University of California Press. [<a href="https://www.practicereproducibleresearch.org/core-chapters/6-future.html" target="_blank">online</a>]</p>

<p>Rokem, A., B. Marwick, V. Staneva 2017 Assessing Reproducibility. In Kitzes, J., Turek, D., &amp; Deniz, F. (Eds.) <em>The Practice of Reproducible Research: Case Studies and Lessons from the Data-Intensive Sciences.</em> Oakland, CA: University of California Press. University of California Press. [<a href="https://www.practicereproducibleresearch.org/core-chapters/2-assessment.html" target="_blank">online</a>]</p>

